Обновления
==========

| Обновления выходят в среднем раз в 3-4 недели (зависит от загруженности).
| По умолчанию обновления устанавливаются автоматически в 02:00 по времени сервера.

Адрес сервера обновлений
^^^^^^^^^^^^^^^^^^^^^^^^^

* free.update.2x.mikbill.pro
* pay.update.2x.mikbill.pro

Скрипты обновлений
^^^^^^^^^^^^^^^^^^^^^

* Для бесплатной версии php 7.2/7.3 - http://free.update.2x.mikbill.pro/mikbill_update.sh
* Для платной версии php 7.2/7.3 - http://pay.update.2x.mikbill.pro/mikbill_update.sh

Автоматическое обновлене
^^^^^^^^^^^^^^^^^^^^^^^^

Обновление происходит из ``cron`` путем запуска скрипта ``/usr/local/sbin/cron_mikbill.sh`` [1]_ который в свою очередь запустит скрипт обновления ``/var/www/mikbill/admin/sys/update/mikbill_update.sh``
Далее, в зависимости от версии апдейтера (платный/бесплатный), скрипт обратиться по адресу домена к серверу обновлений и проверит наличие новых версий:

* апдейтера
* архива с файлами адинки
* архива с файлами html5 интерфейса
* архива с файлами личного кабинета

При наличии новых версий, они будут загружены и установлены на сервер.

.. [1] cron_mikbill.sh - скрипт автоматического определения "типа" системы (centos/debian/bsd), на текущих версиях не столь актуален но остался использоваться в системе.


Ручное обновление
^^^^^^^^^^^^^^^^^^^

Перейти в директорию с обновлениями.

.. code-block:: sh

  cd /var/www/mikbill/admin/sys/update/
  
Понизить текущую версию обновления на 1

.. code-block:: sh

  REV=$(cat mikbill_current); REV=$(($REV-1)); echo $REV > mikbill_current
  
Запустить обновление с правами **sudo** в консоли.

.. code-block:: sh

  ./mikbill_update.sh


Откат обновления
^^^^^^^^^^^^^^^^^^^

| При запуске скрипта обновления, скрипт создает бекап текущей версии если для неё есть новая версия.
| Бекапы создаются в ``/var/mikbill/www_backups/`` в формате ``[admin/stat/html5].[дата_время].tar.gz``

1. admin - содержит файлы бекенда админки и ядра
2. html5 - содержит файлы html5 (фронтенд) админки
3. stat - содержит файлы личного кабинета абонентов

| При откате обновления админки/ядра нужно восстанавливать admin и html5 архивы, для кабинета нужно восстанавливать stat архив.
| Принцип отката обновления один для всех архивов, скопировать архив бекапа и распаковать его:

.. code-block:: sh

  cd /var/www/mikbill/
  cp /var/mikbill/www_backups/admin.2020-09-28_11-53.tar.gz ./
  tar -xzvf admin.2020-09-28_11-53.tar.gz

``admin.2020-09-28_11-53.tar.gz`` заменить на название вашего архива.


Если необходимо поправить права на файлах и директориях:

.. code-block:: sh

  find /var/www/mikbill/ -type f -exec chmod 644 -- {} +
  find /var/www/mikbill/ -type d -exec chmod 755 -- {} +
  find /var/www/mikbill/ -type f -iname "*.sh" -exec chmod +x {} \;
  chown nginx:nginx -R /var/www/mikbill/admin
  chown apache:apache -R /var/www/mikbill/admin/app/log/

Для CentOS систем в chown используется **apache**, для Debian используется **www-data**


Пре-релиз обновления
^^^^^^^^^^^^^^^^^^^^

Пре-релиз обновления - это специальная "сборка" которая включает в себя актуальную версию обновления + наработки которые на данный момент готовы для следующего обновления (новый функционал, багфиксы, новые баги и т.п.).
Доступ к пре-релиз обновлениям возможен только при наличии действующих обновлений начиная с версии 2.14.02.

Для установки пре-релиза необходимо перейти в директорию с пре-релиз обновлениями и запустить скрипт:

.. code-block:: sh

  cd /var/mikbill/updates/pre_release
  ./install_pre-release.sh
  
Вам нужно будет подтвердить что вы осознаете что и зачем делаете написав в консоли "yes", после чего скрипт проверит доступность новой версии сборки с обновлением и если такая найдется, сделает бекап текущих основных файлов админки и установит новую сборку.


Если по какой то причине сборка не подходит вам то вы можете откатить её выполнив скрипт:

.. code-block:: sh

  cd /var/mikbill/updates/pre_release
  ./undo_pre-release.sh
  
Вам так же нужно будет подтвердить что вы понимаете что делаете.
